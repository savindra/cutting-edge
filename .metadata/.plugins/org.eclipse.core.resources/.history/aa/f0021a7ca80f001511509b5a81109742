package lk.ac.iit.humzearch.util;

import java.io.BufferedReader;
import java.io.File;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.net.URL;
import java.net.URLConnection;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.mime.content.FileBody;
import org.apache.http.entity.mime.content.StringBody;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.util.EntityUtils;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import lk.ac.iit.humzearch.model.Tune;
import lk.ac.iit.humzearch.util.AndroidMultiPartEntity.ProgressListener;
import android.app.ProgressDialog;
import android.content.Context;
import android.os.AsyncTask;
import android.util.Log;
import android.widget.Toast;

public class UploadTune extends AsyncTask<Void, Integer, String> {
	
	private static final String TAG = UploadTune.class.getSimpleName();
	
	private final String DORESO_API_KEY = "LLUF2Ei7raogz5tlM7tihDmjR715SGPonLxASq19YBk";
	private final String DORESO_API_LINK = "http://developer.doreso.com/api/v1/song/identify";
	private String doresoType;
	
	private String ITUNES_LINK = "https://itunes.apple.com/search";
	
	private Context context;
	private ProgressDialog progressDialog;
	private String tuneFile;
	private Tune tune;
	
	private JSONArray tuneData;
	
	public UploadTune(Context context, String tuneFile, String doresoType) {
		super();
		this.context = context;
		this.tuneFile = "/storage/emulated/0/Download/test.mp3";
		this.doresoType = doresoType;
		tune = new Tune();
	}

	@Override
	protected void onPreExecute() {
		progressDialog = ProgressDialog.show(context, "", "Searching...", true);
		super.onPreExecute();
	}

	@Override
	protected String doInBackground(Void... params) {
		String response = recognizeTune();
		String statusCode, msg, data;
		try{
			JSONObject jsonObj = new JSONObject(response);
			statusCode = jsonObj.getString("status");
			msg = jsonObj.getString("msg");
			
			Log.d(TAG, statusCode + " " + msg );
			
			if(statusCode.equals("1") && msg.equals("success")){
				tuneData = jsonObj.getJSONArray("data");
				
				JSONObject t = tuneData.getJSONObject(0);
				tune.setTitle(t.getString("name"));
				tune.setArtist(t.getString("artist_name"));
				tune.setAlbum(t.getString("album"));
				
				String metaData = getArtwork();
				Log.d(TAG, metaData);
				jsonObj = new JSONObject(metaData);
				
				statusCode = null;
				statusCode = jsonObj.getString("resultCount");
				
				if(statusCode.equals("1")){
					tuneData = jsonObj.getJSONArray("results");
					
					t = tuneData.getJSONObject(0);
					tune.setImg(t.getString("artworkUrl100"));
					tune.setCountry(t.getString("country"));
					tune.setUrl(t.getString("previewUrl"));
					
				}
				
			}
			
		}catch(JSONException e){
			Log.d(TAG, e.toString());
		}
		Log.d(TAG, tune.toString());
		return tune.toString();
	}
	
	public String getArtwork(){
		StringBuilder sb = new StringBuilder();
		
		ITUNES_LINK += "?term=" + tune.getTitle().replace(" ", "+").trim() + "+" +
				tune.getArtist().replace(" ", "+").trim() + "&media=music&entity=song&limit=1";
		
		Log.d(TAG, ITUNES_LINK);
		try{
			URL url = new URL(ITUNES_LINK);
			URLConnection conn = url.openConnection();
			conn.setDoOutput(true); 
		    BufferedReader reader = new BufferedReader(new InputStreamReader(conn.getInputStream()));
		    String line = "";
		    
		   for(int i =0; i<=reader.read(); i++){
			   line  += reader.readLine();  
		   }
		   //line.replace(": [", ": [{");
		   //line.replace("}]", "}]}");
		   sb.append(line);
		    
		}catch(Exception e){
			Log.d(TAG, e.toString());
		}
		return sb.toString();
	}
	
	
	
	@SuppressWarnings("deprecation")
	public String recognizeTune(){
		String responseString = null;
		
		HttpClient httpClient = new DefaultHttpClient();
		HttpPost httpPost = new HttpPost(DORESO_API_LINK);
		
		try{
			AndroidMultiPartEntity entity = new AndroidMultiPartEntity(new ProgressListener() {
				
				@Override
				public void transferred(long num) {
					// TODO Auto-generated method stub
					
				}
			});
			
			File sourceFile = new File(tuneFile);
			
			entity.addPart("track", new FileBody(sourceFile));
			entity.addPart("api_key", new StringBody(DORESO_API_KEY));
			Log.d(TAG, tuneFile);
			
			httpPost.setEntity(entity);
			
			HttpResponse response = httpClient.execute(httpPost);
			HttpEntity r_entity = response.getEntity();
			
			int statusCode = response.getStatusLine().getStatusCode();
			
			if(statusCode == 200){
				responseString = EntityUtils.toString(r_entity);
			} else {
				responseString = "Error occurred! Http Status Code: " + statusCode;
			}
			
		} catch (ClientProtocolException e){
			responseString = e.toString();
		} catch (Exception e){
			responseString = e.toString();
			e.printStackTrace();
		}
		return responseString;
	}
	
	@Override
	protected void onPostExecute(String result) {
		progressDialog.dismiss();
		Toast.makeText(context, result, Toast.LENGTH_LONG).show();
		super.onPostExecute(result);
	}

}
